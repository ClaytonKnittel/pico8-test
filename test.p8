pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
music(0, -1)

LEFT = 0
RIGHT = 1
UP = 2
DOWN = 3
BTN_X = 4
BTN_Z = 5

ANIMATION_FREQ = 8

JUMP_DY = 7
DX = 1
FLOOR_Y = 12 * 8
G = 1

time = 0

function distance(pos1, pos2)
  return sqrt((pos1.x - pos2.x) ^ 2 + (pos1.y - pos2.y) ^ 2)
end

function MakePosition(x, y)
  local position = {
    x = x,
    y = y,
    dx = 0,
    dy = 0
  }

  function position:update()
    self.x += self.dx
    self.dy += G
    self.y += self.dy

    if self.y >= FLOOR_Y then
      self.y = FLOOR_Y
      self.dy = 0
    end
  end

  return position
end

function AttachPlayerActions(player)
  player.sprite = 16

  function player:jump(jump_dy)
    if (self.position.y >= FLOOR_Y) self.position.dy = -jump_dy
  end

  function player:update()
    if btn(LEFT) then
      self.position.dx = -DX
    elseif btn(RIGHT) then
      self.position.dx = DX
    else
      self.position.dx = 0
    end

    if (btnp(BTN_Z)) self:jump(JUMP_DY)
    self.position:update()
  end

  function player:draw_index()
    return self.sprite + flr(time / ANIMATION_FREQ) % 2
  end

  return player
end

ENEMY_IDLE = 0
ENEMY_HUNGRY = 1

ENEMY_DX = 0.05

function AttachEnemyActions(enemy)
  enemy.sprite = 32
  enemy.state = ENEMY_IDLE
  enemy.direction = -1

  function enemy:update()
    if distance(self.position, player.position) <= 32 then
      if self.state ~= ENEMY_HUNGRY then
        self.state = ENEMY_HUNGRY
        self.start_time = time
      end
    else
      self.state = ENEMY_IDLE
      self.start_time = nil
    end

    if self.position.x > player.position.x then
      enemy.direction = -1
      self.position.dx = max(self.position.dx - ENEMY_DX, -1)
    else
      enemy.direction = 1
      self.position.dx = min(self.position.dx + ENEMY_DX, 1)
    end

    self.position:update()
  end

  function enemy:draw_index()
    if self.state == ENEMY_IDLE then
      return self.sprite + flr(time / ANIMATION_FREQ) % 2
    else
      local idx = flr(2 * (time - self.start_time) / ANIMATION_FREQ)
      return self.sprite + 2 + min(idx % 4, 4 - idx % 4)
    end
  end

  function enemy:flip_x()
    return self.direction > 0
  end

  return enemy
end

function BuildEntity(x, y)
  local entity = {
    position = MakePosition(x, y)
  }

  function entity:flip_x()
    return false
  end
  function entity:flip_y()
    return false
  end

  function entity:draw()
    spr(self:draw_index(), self.position.x, self.position.y, 1, 1, self:flip_x(), self:flip_y())
  end

  return entity
end

player = AttachPlayerActions(BuildEntity(8, 12 * 8, 16))
enemies = {
  AttachEnemyActions(BuildEntity(15 * 8, 12 * 8, 32))
}

function UpdateEntities()
  player:update()
  for i, enemy in ipairs(enemies) do
    enemy:update()
  end
end

function _update()
  UpdateEntities()
  time += 1
end

function _draw()
  cls(0)
  map(0, 0, 0, 0, 16, 16, 0)

  player:draw()
  for i, enemy in ipairs(enemies) do
    enemy:draw()
  end
end

__gfx__
0000000000000000bbbbbbbb44444444444444444444444400000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000b4b4bb4b44444444444404404440444000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000000000044b44b4444444444040400404400404000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000004444444444444444000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000004444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000004444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000004444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000004444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ff000000ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ff000000ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08555580085555800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08855880088558800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666600000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aa00aa000aaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0aa00aa000aaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000007202000000722000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002200000022000220220000072a20000002a200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022220000222200702a220000002220000722200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22a11a2222a11a2200701a2207071a2270701a220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111110011111100111111001111110111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100100001001000010010000100100001001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c000c0000c00c0000c00c000c000c0000c00c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01000010001001000010010001000010001001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404050404050504050404050405050400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010a00003b04000000000000000020040000000000000000000000000000000000002704000000000000000026040000001604000000000000000000000000001604000000000000000000000000000000000000
010a000000002000020000200002000020000200002000020c6550000200002000020000200002000020000200000000000c6060c6250c655000000c655000000c60500000000000c6050c655000000000000000
010a000003060030000000000000000000000007060070600a0600000000000000000c06000000000000000000000000000f000000000f0600f0600e0600e0600007000070000000000000070000700000000000
__music__
00 00014344
00 00014344
03 00010244

